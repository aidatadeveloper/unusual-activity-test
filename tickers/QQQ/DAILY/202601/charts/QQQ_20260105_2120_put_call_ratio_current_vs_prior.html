<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQQ - Put/Call Ratio - Current vs Prior % (1/5)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Modal/Popup Styling - matches original exactly */
        .chart-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .chart-container {
            background: rgba(0, 15, 0, 0.95);
            border: 1px solid rgba(0, 255, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
        }

        .chart-header h3 {
            font-size: 18px;
            font-weight: normal;
            flex: 1;
            text-align: center;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid rgba(0, 255, 0, 0.5);
            color: #0f0;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
        }

        .nav-btn:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #0f0;
        }

        .chart-close {
            background: transparent;
            border: 1px solid rgba(0, 255, 0, 0.5);
            color: #0f0;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-close:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #f00;
            color: #f00;
        }

        .chart-body {
            min-height: 300px;
            position: relative;
        }

        .timestamp {
            text-align: center;
            color: rgba(0, 255, 0, 0.5);
            font-size: 0.75rem;
            margin-top: 15px;
        }

        .header-controls {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="chart-modal">
        <div class="chart-container">
            <div class="chart-header">
                <a href="QQQ_20260102_2048_put_call_ratio_current_vs_prior.html" class="nav-btn" id="prevBtn" title="Previous" style="">&larr;</a>
                <h3>QQQ - Put/Call Ratio - Current vs Prior % (1/5)</h3>
                <div class="header-controls">
                    <a href="#" class="nav-btn" id="nextBtn" title="Next" style="visibility:hidden;">&rarr;</a>
                    <a href="../QQQ_20260105_2120.html" class="chart-close" id="closeBtn" title="Back to Dashboard (ESC)">&times;</a>
                </div>
            </div>
            <div class="chart-body">
                <canvas id="metricChart"></canvas>
            </div>
            <div class="timestamp">Generated: 2026-01-05 21:20:02</div>
        </div>
    </div>
    <script>
        const chartData = {"labels": ["09:35", "09:40", "09:45", "09:50", "09:55", "10:00", "10:05", "10:10", "10:15", "10:20", "10:25", "10:30", "10:35", "10:40", "10:45", "10:50", "10:55", "11:00", "11:05", "11:10", "11:15", "11:20", "11:25", "11:30", "11:35", "11:40", "11:45", "11:50", "11:55", "12:00", "12:05", "12:10", "12:15", "12:20", "12:25", "12:30", "12:35", "12:40", "12:45", "12:50", "12:55", "13:00", "13:05", "13:10", "13:15", "13:20", "13:25", "13:30", "13:35", "13:40", "13:45", "13:50", "13:55", "14:00", "14:05", "14:10", "14:15", "14:20", "14:25", "14:30", "14:35", "14:40", "14:45", "14:50", "14:55", "15:00", "15:05", "15:10", "15:15", "15:20", "15:25", "15:30", "15:35", "15:40", "15:45", "15:50", "15:55", "16:00", "16:05", "16:10", "16:15", "16:20"], "call_values": [143936, 207964, 300523, 361357, 402168, 438174, 493140, 534891, 560623, 601036, 632693, 683184, 722193, 751475, 786127, 804011, 821415, 839276, 853302, 885314, 911535, 925759, 939551, 954861, 974792, 988200, 1008588, 1034129, 1052568, 1076567, 1090716, 1106830, 1128858, 1157219, 1185956, 1219463, 1244165, 1267519, 1286911, 1309219, 1326413, 1336439, 1347223, 1381840, 1409032, 1461197, 1497106, 1525893, 1543131, 1564009, 1582878, 1598288, 1615324, 1624315, 1637026, 1653260, 1669661, 1678373, 1696543, 1723260, 1735843, 1759906, 1788211, 1814699, 1827671, 1843950, 1861190, 1888799, 1906555, 1921887, 1934237, 1948728, 1964389, 1973423, 2006968, 2026084, 2050762, 2081054, 2095157, 2103618, 2112184, 2112184], "put_values": [135386, 214340, 276291, 338899, 378743, 419200, 473722, 519173, 556320, 594970, 632231, 683164, 720846, 766507, 798029, 818304, 842643, 867376, 883507, 925531, 968192, 989902, 1009008, 1027480, 1062461, 1078867, 1105468, 1149945, 1194557, 1231980, 1251724, 1273686, 1302876, 1331793, 1375269, 1420262, 1456774, 1475472, 1500698, 1520135, 1533613, 1544096, 1554601, 1597029, 1624667, 1685322, 1716434, 1747800, 1761223, 1780442, 1801517, 1829595, 1841665, 1854993, 1865413, 1885039, 1903852, 1911323, 1924135, 1946118, 1968959, 2003797, 2039534, 2066591, 2080007, 2100085, 2115773, 2135594, 2155908, 2166950, 2184239, 2198511, 2217590, 2228676, 2255684, 2275699, 2302796, 2331207, 2342502, 2359332, 2373237, 2373237], "is_stacked_call_put": true};
        const ctx = document.getElementById('metricChart').getContext('2d');

        const chartType = 'bar';
        const isPie = chartType === 'pie';
        const isCallPutChart = true;
        const isTimeline = chartData.is_timeline === true;
        const isPutTimeline = chartData.is_put_timeline === true;  // Red bars for Put-only charts
        const isCallPutTimeline = chartData.is_call_put_timeline === true;
        const isGroupedCallPut = chartData.is_grouped_call_put === true;  // Side-by-side bars
        const isStackedCallPut = chartData.is_stacked_call_put === true;  // Stacked bars - calls on bottom, puts on top
        const isGrouped = chartData.is_grouped === true;
        const isPercentage = chartData.is_percentage === true;
        const isComparisonTimeline = chartData.is_comparison_timeline === true;  // Current vs Prior line comparison
        const isPutChart = chartData.is_put_chart === true;  // Red bars for Put-only chart

        // Color schemes - Green for Calls, Red for Puts
        const callPutColors = ['rgba(0, 255, 0, 0.8)', 'rgba(255, 50, 50, 0.8)'];
        const callPutBorders = ['rgba(0, 255, 0, 0.9)', 'rgba(255, 50, 50, 0.9)'];
        // Varying shades of green for non-call/put bar charts
        const barColors = ['rgba(0, 255, 0, 0.7)', 'rgba(0, 200, 0, 0.7)', 'rgba(0, 150, 0, 0.7)', 'rgba(0, 100, 0, 0.7)', 'rgba(0, 180, 0, 0.7)', 'rgba(0, 220, 0, 0.7)', 'rgba(0, 160, 0, 0.7)'];
        const lineColor = 'rgba(0, 255, 0, 1)';

        // Colors for grouped comparison charts (Prior vs Current)
        const groupedColors = [
            { bg: 'rgba(255, 165, 0, 0.7)', border: 'rgba(255, 165, 0, 0.9)' },  // Orange for Prior
            { bg: 'rgba(0, 255, 0, 0.7)', border: 'rgba(0, 255, 0, 0.9)' }       // Green for Current
        ];

        // Build datasets based on chart type
        let datasets;
        if (isGroupedCallPut) {
            // Call/Put side-by-side grouped bars (Option Volume)
            datasets = [
                {
                    label: 'Calls',
                    data: chartData.call_values,
                    backgroundColor: 'rgba(0, 255, 0, 0.7)',
                    borderColor: 'rgba(0, 255, 0, 0.9)',
                    borderWidth: 1
                },
                {
                    label: 'Puts',
                    data: chartData.put_values,
                    backgroundColor: 'rgba(255, 50, 50, 0.7)',
                    borderColor: 'rgba(255, 50, 50, 0.9)',
                    borderWidth: 1
                }
            ];
        } else if (isStackedCallPut) {
            // Stacked bar chart - calls on bottom (green), puts on top (red)
            datasets = [
                {
                    label: 'Calls',
                    data: chartData.call_values,
                    backgroundColor: 'rgba(0, 255, 0, 0.7)',
                    borderColor: 'rgba(0, 255, 0, 0.9)',
                    borderWidth: 1,
                    stack: 'callput'
                },
                {
                    label: 'Puts',
                    data: chartData.put_values,
                    backgroundColor: 'rgba(255, 50, 50, 0.7)',
                    borderColor: 'rgba(255, 50, 50, 0.9)',
                    borderWidth: 1,
                    stack: 'callput'
                }
            ];
        } else if (isCallPutTimeline) {
            // Call/Put stacked bar chart
            datasets = [
                {
                    label: 'Calls',
                    data: chartData.call_values,
                    backgroundColor: 'rgba(0, 255, 0, 0.7)',
                    borderColor: 'rgba(0, 255, 0, 0.9)',
                    borderWidth: 1,
                    stack: 'actual'
                },
                {
                    label: 'Puts',
                    data: chartData.put_values,
                    backgroundColor: 'rgba(255, 50, 50, 0.7)',
                    borderColor: 'rgba(255, 50, 50, 0.9)',
                    borderWidth: 1,
                    stack: 'actual'
                }
            ];
        } else if (isComparisonTimeline && chartData.datasets) {
            // Line chart comparing Prior vs Current
            const comparisonLineColors = [
                { bg: 'rgba(255, 165, 0, 0.2)', border: 'rgba(255, 165, 0, 1)' },  // Orange for Prior
                { bg: 'rgba(0, 255, 0, 0.2)', border: 'rgba(0, 255, 0, 1)' }       // Green for Current
            ];
            datasets = chartData.datasets.map((ds, i) => ({
                label: ds.label,
                data: ds.values,
                backgroundColor: comparisonLineColors[i % comparisonLineColors.length].bg,
                borderColor: comparisonLineColors[i % comparisonLineColors.length].border,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                spanGaps: false,  // Don't connect across null values - show gaps
                pointRadius: 2,
                pointHoverRadius: 5
            }));
        } else if (isGrouped && chartData.datasets) {
            // Grouped bar chart comparing Prior vs Current
            // Use dataset color if provided, otherwise fall back to default groupedColors
            datasets = chartData.datasets.map((ds, i) => {
                const defaultColor = groupedColors[i % groupedColors.length];
                const customColor = ds.color;
                // Convert hex color to rgba if provided (e.g., #dc3545 -> rgba(220, 53, 69, 0.7))
                let bgColor = defaultColor.bg;
                let borderColor = defaultColor.border;
                if (customColor) {
                    // Parse hex color
                    const hex = customColor.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    bgColor = `rgba(${r}, ${g}, ${b}, 0.7)`;
                    borderColor = `rgba(${r}, ${g}, ${b}, 0.9)`;
                }
                return {
                    label: ds.label,
                    data: ds.values,
                    backgroundColor: bgColor,
                    borderColor: borderColor,
                    borderWidth: 1
                };
            });
        } else if (isPutTimeline) {
            // Put-only intraday timeline - RED bars
            datasets = [
                {
                    label: 'Puts',
                    data: chartData.actual_values,
                    backgroundColor: 'rgba(255, 50, 50, 0.7)',
                    borderColor: 'rgba(255, 50, 50, 0.9)',
                    borderWidth: 1
                }
            ];
        } else if (isTimeline) {
            // Call intraday timeline - GREEN bars (default)
            datasets = [
                {
                    label: 'Calls',
                    data: chartData.actual_values,
                    backgroundColor: 'rgba(0, 255, 0, 0.7)',
                    borderColor: 'rgba(0, 255, 0, 0.9)',
                    borderWidth: 1
                }
            ];
        } else if (chartData.is_dual_line) {
            // Dual-line chart (e.g., Current vs Next Expected Move, or Calls vs Puts)
            const lineLabels = chartData.line_labels || ['Line 1', 'Line 2'];
            // Use red for Puts, blue for other second lines
            const isPutsLine = lineLabels[1] === 'Puts';
            const line2Color = isPutsLine ? 'rgba(255, 50, 50, 1)' : 'rgba(0, 200, 255, 1)';
            const line2BgColor = isPutsLine ? 'rgba(255, 50, 50, 0.2)' : 'rgba(0, 200, 255, 0.2)';
            const line2PointColor = isPutsLine ? 'rgba(255, 50, 50, 1)' : 'rgba(0, 200, 255, 1)';
            datasets = [
                {
                    label: lineLabels[0],
                    data: chartData.values,
                    backgroundColor: 'rgba(0, 255, 0, 0.2)',
                    borderColor: 'rgba(0, 255, 0, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    spanGaps: false,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: chartData.highlight_last ?
                        chartData.values.map((v, i) => i === chartData.values.length - 1 ? 'rgba(0, 255, 0, 1)' : 'rgba(0, 255, 0, 0.7)') :
                        'rgba(0, 255, 0, 0.7)'
                },
                {
                    label: lineLabels[1],
                    data: chartData.next_values,
                    backgroundColor: line2BgColor,
                    borderColor: line2Color,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    spanGaps: false,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointStyle: 'circle',
                    pointBackgroundColor: line2PointColor
                }
            ];
        } else {
            // Standard single-dataset chart
            let bgColors, borderColors;
            if (isPie || isCallPutChart) {
                bgColors = callPutColors;
                borderColors = callPutBorders;
            } else if (chartType === 'line') {
                bgColors = 'rgba(0, 255, 0, 0.2)';
                borderColors = lineColor;
            } else if (isPutChart) {
                // Red bars for put-only charts
                bgColors = 'rgba(255, 50, 50, 0.7)';
                borderColors = 'rgba(255, 50, 50, 0.9)';
            } else {
                bgColors = barColors.slice(0, chartData.values.length);
                borderColors = 'rgba(0, 255, 0, 0.9)';
            }
            datasets = [{
                label: 'PUT CALL RATIO',
                data: chartData.values,
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: chartType === 'line' ? 2 : 1,
                tension: 0.4,
                fill: chartType === 'line' ? false : undefined
            }];
        }

        new Chart(ctx, {
            type: chartType,
            data: {
                labels: chartData.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#0f0',
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                let label = context.label || context.dataset.label || '';
                                if (isPercentage) {
                                    return label + ': ' + value.toFixed(2) + '%';
                                }
                                if (typeof value === 'number') {
                                    if (value >= 1000000000) {
                                        return label + ': $' + (value / 1000000000).toFixed(2) + 'B';
                                    } else if (value >= 1000000) {
                                        return label + ': $' + (value / 1000000).toFixed(2) + 'M';
                                    } else if (value >= 1000) {
                                        return label + ': ' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return label + ': ' + value.toLocaleString();
                                }
                                return label + ': ' + value;
                            }
                        }
                    }
                },
                scales: isPie ? undefined : {
                    x: {
                        stacked: isCallPutTimeline || isStackedCallPut,
                        ticks: {
                            color: '#0f0'
                        },
                        grid: {
                            color: 'rgba(0, 255, 0, 0.1)'
                        }
                    },
                    y: isPercentage ? {
                        stacked: isCallPutTimeline || isStackedCallPut,
                        ticks: {
                            color: '#0f0',
                            callback: function(value) {
                                return value.toFixed(2) + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 255, 0, 0.1)'
                        }
                    } : {
                        stacked: isCallPutTimeline || isStackedCallPut,
                        ticks: {
                            color: '#0f0',
                            callback: function(value) {
                                if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                return value;
                            }
                        },
                        grid: {
                            color: 'rgba(0, 255, 0, 0.1)'
                        }
                    }
                }
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // ESC key - go back to dashboard
                window.location.href = '../QQQ_20260105_2120.html';
            } else if (e.key === 'ArrowLeft') {
                // Left arrow - go to previous chart
                const prevBtn = document.getElementById('prevBtn');
                if (prevBtn && prevBtn.style.visibility !== 'hidden') {
                    window.location.href = prevBtn.href;
                }
            } else if (e.key === 'ArrowRight') {
                // Right arrow - go to next chart
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn && nextBtn.style.visibility !== 'hidden') {
                    window.location.href = nextBtn.href;
                }
            }
        });
    </script>
</body>
</html>